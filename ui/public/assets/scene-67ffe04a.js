const gt=[1,1,1,1],ce=[.5,.5,.5,1],St=[1,1,0,1],vt=[0,1,0,1],Et=[0,0,1,1],Pt=[1,.5,0,1],Ot=[1,0,0,1],Mt=[0,0,0,1],ut=[gt,vt,St,Et,Pt,Ot];function lt(i){return(i<0||i>=ut.length)&&console.error("Invalid face: "+i),ut[i]}const J={};function Dt(i){const e=i.layers,t=i.gl,s=i.perspectiveMatrix,n=`${e}-${s}`;if(J[n])return J[n];let r=tt(e,1.01,.02),a=tt(e,1,0),o=tt(e,1.5,.02);const h=Array(R(e));for(let c=0;c<R(e);c++){let u={positionBuffer:t.createBuffer(),noGapPositionBuffer:t.createBuffer(),hintPositionBuffer:t.createBuffer(),indexBuffer:t.createBuffer(),cart2d:[],positions:null},l=new Float32Array(12),f=new Float32Array(12),p=new Float32Array(12);for(let x=0;x<12;x++){let g=c*12+x;l[x]=r[g],f[x]=a[g],p[x]=o[g]}t.bindBuffer(t.ARRAY_BUFFER,u.positionBuffer),t.bufferData(t.ARRAY_BUFFER,l,t.STATIC_DRAW),u.positions=l,t.bindBuffer(t.ARRAY_BUFFER,u.noGapPositionBuffer),t.bufferData(t.ARRAY_BUFFER,f,t.STATIC_DRAW),t.bindBuffer(t.ARRAY_BUFFER,u.hintPositionBuffer),t.bufferData(t.ARRAY_BUFFER,p,t.STATIC_DRAW);const m=Array(16);X(m,0,s,[f[0],f[1],f[2],1]),X(m,4,s,[f[3],f[4],f[5],1]),X(m,8,s,[f[6],f[7],f[8],1]),X(m,12,s,[f[9],f[10],f[11],1]),u.cart2d=[m[0]/m[3],m[1]/m[3],m[4]/m[7],m[5]/m[7],m[8]/m[11],m[9]/m[11],m[12]/m[15],m[13]/m[15]];const k=[0,1,2,0,2,3];t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,u.indexBuffer),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(k),t.STATIC_DRAW),h[c]=u}return J[n]=h,h}function X(i,e,t,s){let n=s[0],r=s[1],a=s[2],o=s[3];i[e+0]=n*t[0]+r*t[4]+a*t[8]+o*t[12],i[e+1]=n*t[1]+r*t[5]+a*t[9]+o*t[13],i[e+2]=n*t[2]+r*t[6]+a*t[10]+o*t[14],i[e+3]=n*t[3]+r*t[7]+a*t[11]+o*t[15]}const At=12,Ft=4,W=3;function tt(i,e,t){const s=d(i)*At,n=Array(6*s);return Lt(n,0*s,i,1,e,t),Bt(n,1*s,i,0,e,t),Ct(n,2*s,i,1,-e,t),_t(n,3*s,i,0,-e,t),Kt(n,4*s,i,2,-e,t),Ut(n,5*s,i,2,e,t),n}function Lt(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=0;u<t;u++)for(let l=0;l<t;l++){const f=-1+1/t+l*2/t,p=-1+1/t+u*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=-y(t);h<=y(t);h++)for(let c=-y(t);c<=y(t);c++)a[o]=[2*c/t,2*h/t,n],o++;v(i,e,t,a,s,r)}function Bt(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=0;u<t;u++)for(let l=t-1;l>=0;l--){const f=-1+1/t+u*2/t,p=-1+1/t+l*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=-y(t);h<=y(t);h++)for(let c=y(t);c>=-y(t);c--)a[o]=[2*h/t,2*c/t,n],o++;v(i,e,t,a,s,r)}function Ct(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=0;u<t;u++)for(let l=t-1;l>=0;l--){const f=-1+1/t+l*2/t,p=-1+1/t+u*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=-y(t);h<=y(t);h++)for(let c=y(t);c>=-y(t);c--)a[o]=[2*c/t,2*h/t,n],o++;v(i,e,t,a,s,r)}function _t(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=0;u<t;u++)for(let l=0;l<t;l++){const f=-1+1/t+u*2/t,p=-1+1/t+l*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=-y(t);h<=y(t);h++)for(let c=-y(t);c<=y(t);c++)a[o]=[2*h/t,2*c/t,n],o++;v(i,e,t,a,s,r)}function Kt(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=0;u<t;u++)for(let l=t-1;l>=0;l--){const f=-1+1/t+l*2/t,p=-1+1/t+u*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=-y(t);h<=y(t);h++)for(let c=y(t);c>=-y(t);c--)a[o]=[2*c/t,2*h/t,n],o++;v(i,e,t,a,s,r)}function Ut(i,e,t,s,n,r){if(V(t)){let h=Array(d(t)),c=0;for(let u=t-1;u>=0;u--)for(let l=t-1;l>=0;l--){const f=-1+1/t+l*2/t,p=-1+1/t+u*2/t;h[c]=[f,p,n],c++}v(i,e,t,h,s,r);return}let a=Array(d(t)),o=0;for(let h=y(t);h>=-y(t);h--)for(let c=y(t);c>=-y(t);c--)a[o]=[2*c/t,2*h/t,n],o++;v(i,e,t,a,s,r)}function v(i,e,t,s,n,r){for(let a=0;a<d(t);a++){const o=s[a];wt(i,e+a*At,t,o[0],o[1],o[2],n,r)}}function wt(i,e,t,s,n,r,a,o){const h=1/t-o,c=[[s-h,n-h,r],[s+h,n-h,r],[s+h,n+h,r],[s-h,n+h,r]];for(let u=0;u<Ft;u++){const l=c[u];i[e+u*W]=l[(a+0)%W],i[e+u*W+1]=l[(a+1)%W],i[e+u*W+2]=l[(a+2)%W]}}function $(i){return Math.floor(Math.random()*i)}function It(i){let e=i.length;for(;e!=0;){let t=$(e);e--;let s=i[t];i[t]=i[e],i[e]=s}return i}const w=0,I=1,Y=2,H=3,z=4,j=5,Yt=[[w,H,z],[w,j,H],[w,z,I],[w,I,j],[Y,I,z],[Y,j,I],[Y,z,H],[Y,H,j]],Ht=[[w,H],[w,z],[w,j],[w,I],[I,z],[I,j],[Y,I],[Y,z],[Y,j],[Y,H],[H,z],[H,j]];function zt(i){let e=ft(12,2),t=ft(8,3),s=et(8),n=et(12);for(;dt(s)!==dt(n);)s=et(8);const r=Array(54);for(let A=0;A<6;A++){const O=i.center(A);r[O]=A}let a=i.corners(0,0),o=i.corners(1,0),h=i.corners(2,0),c=i.corners(3,0),u=i.corners(4,0),l=i.corners(5,0);const f=(A,O,Q,M,D,F,L,B,C)=>{const T=(E,_)=>Yt[s[E]][(t[E]+_)%3];r[A.topLeft]=T(O,F),r[A.topRight]=T(Q,L),r[A.bottomLeft]=T(M,B),r[A.bottomRight]=T(D,C)};f(a,0,1,2,3,0,0,0,0),f(o,2,3,4,5,2,1,1,2),f(h,4,5,6,7,0,0,0,0),f(c,6,7,0,1,2,1,1,2),f(u,0,2,6,4,2,1,1,2),f(l,3,1,5,7,2,1,1,2);let p=i.edges(0,0,0),m=i.edges(1,0,0),k=i.edges(2,0,0),x=i.edges(3,0,0),g=i.edges(4,0,0),N=i.edges(5,0,0);const S=(A,O,Q,M,D,F,L,B,C)=>{const T=(E,_)=>Ht[n[E]][(e[E]+_)%2];r[A.top]=T(O,F),r[A.left]=T(Q,L),r[A.right]=T(M,B),r[A.bottom]=T(D,C)};return S(p,0,1,2,3,0,0,0,0),S(m,3,4,5,6,1,0,0,1),S(k,6,7,8,9,0,0,0,0),S(x,9,10,11,0,1,0,0,1),S(g,1,10,4,7,1,1,1,1),S(N,2,5,11,8,1,1,1,1),r}function ft(i,e){const t=Array(i);for(let s=0;s<i;s++)t[s]=$(e);for(;!jt(t,e);){const s=$(i);t[s]=$(e)}return t}function jt(i,e){let t=0;for(let s=0;s<i.length;s++)t+=i[s];return t%e===0}function et(i){const e=Array(i);for(let t=0;t<i;t++)e[t]=t;return It(e),e}function dt(i){const e=[...i];let t=!1;for(;;)if(e[0]===0){const s=e.findIndex((n,r)=>n!==r);if(s===-1)return t;e[0]=e[s],e[s]=0,t=!t}else{const s=e[0];e[0]=e[s],e[s]=s,t=!t}}let U;function it(i,e){const t=[e[0],e[1],e[2],e[3],e[0],e[1],e[2],e[3],e[0],e[1],e[2],e[3],e[0],e[1],e[2],e[3]];U.bindBuffer(U.ARRAY_BUFFER,i.buffer),U.bufferData(U.ARRAY_BUFFER,new Float32Array(t),U.STATIC_DRAW)}function d(i){return i*i}function y(i){return Math.floor(i/2)}function V(i){return i%2==0}function R(i){return i*i*6}class Nt{stickers;underStickers;layers;affectedStickers;disableTurn;clockwise;animationQueue;gl;perspectiveMatrix;buffers;constructor(e,t){U=e,this.animationQueue=[],this.gl=e,this.perspectiveMatrix=t}setColors(e){for(let t=0;t<R(this.layers);t++)it(this.stickers[t],e[t])}solve(){const e=Array(R(this.layers));for(let t=0;t<R(this.layers);t++){const s=this.stickerToFace(t);this.stickers[t].face=s,e[t]=lt(s)}this.setColors(e)}scramble(){if(this.layers===3){this.scramble3x3();return}this.naiveScramble()}scramble3x3(){const e=zt(this);this.setCubeState(e)}naiveScramble(){let e=d(this.layers)*10;for(let t=0;t<e;t++){let s=Math.floor(Math.random()*3),n=Math.floor(Math.random()*this.layers),r=Math.floor(Math.random()*1)==0;this.matchTurn(s,n,r)}}setNumOfLayers(e){this.layers=e,this.stickers=Array(R(e)),this.underStickers=Array(R(e));for(let t=0;t<R(e);t++){const s=this.stickerToFace(t);this.stickers[t]={face:s,buffer:U.createBuffer()},this.underStickers[t]={face:s,buffer:U.createBuffer()},it(this.underStickers[t],Mt)}this.affectedStickers=Array(R(e)).fill(!1),this.buffers=Dt(this),this.solve()}getCubeState(){return this.stickers.map(e=>e.face)}setCubeState(e){for(let t=0;t<R(this.layers);t++){const s=lt(e[t]);this.stickers[t].face=e[t],it(this.stickers[t],s)}}resetAffectedStickers(){const e=Array(R(this.layers));this.affectedStickers=e.fill(this.layers===1)}pushAnimation(e,t,s){let n=t?-1:1,r=[0,0,0];r[e]=n,this.animationQueue.push({axis:r,stickers:s,stickersToAnimate:this.affectedStickers})}turn(e,t,s){this.resetAffectedStickers(),this.pushAnimation(e,s,[...this.stickers]),this.matchTurn(e,t,s)}sliceTurn(e,t){const s=Array(R(this.layers));this.affectedStickers=s.fill(!1),this.pushAnimation(e,t,[...this.stickers]);for(let n=1;n<this.layers-1;n++)this.matchTurn(e,n,t)}wideTurn(e,t,s){this.resetAffectedStickers(),this.pushAnimation(e,s,[...this.stickers]),this.matchTurn(e,t,s);for(let n=1;n<this.layers-1;n++)this.matchTurn(e,n,s)}cubeRotate(e,t){this.resetAffectedStickers(),this.pushAnimation(e,t,[...this.stickers]);for(let s=0;s<this.layers;s++)this.matchTurn(e,s,t)}matchTurn(e,t,s){e==0?(this.turnXAxis(t,s),t==0?this.turnOuter(5,s):t==this.layers-1&&this.turnOuter(4,!s)):e==1?(this.turnYAxis(t,s),t==0?this.turnOuter(0,s):t==this.layers-1&&this.turnOuter(2,!s)):e==2?(this.turnZAxis(t,s),t==0?this.turnOuter(1,s):t==this.layers-1&&this.turnOuter(3,!s)):console.error(`Axis ${e} not recognized`)}turnXAxis(e,t){for(let s=1;s<=this.layers;s++)this.cycle(t,0*d(this.layers)+d(this.layers)-s-e*this.layers,3*d(this.layers)+d(this.layers)-s-e*this.layers,2*d(this.layers)+d(this.layers)-s-e*this.layers,1*d(this.layers)+d(this.layers)-s-e*this.layers)}turnYAxis(e,t){for(let s=0;s<this.layers;s++)this.cycle(t,1*d(this.layers)+s*this.layers+e,4*d(this.layers)+s*this.layers+e,3*d(this.layers)+(this.layers-s-1)*this.layers+(this.layers-1)-e,5*d(this.layers)+s*this.layers+e)}turnZAxis(e,t){for(let s=0;s<this.layers;s++)this.cycle(t,0*d(this.layers)+(s+1)*this.layers-1-e,5*d(this.layers)+s+this.layers*e,2*d(this.layers)+(this.layers-s-1)*this.layers+e,4*d(this.layers)+d(this.layers)-(s+1)-e*this.layers)}turnOuter(e,t){if(this.layers%2!=0){let s=this.center(e);this.affectedStickers[s]=!0}for(let s=0;s<Math.floor(this.layers/2);s++){const{topLeft:n,topRight:r,bottomLeft:a,bottomRight:o}=this.corners(e,s);this.cycle(t,n,r,o,a);let h=this.layers-2*(s+1);for(let c=0;c<h;c++){const{top:u,left:l,bottom:f,right:p}=this.edges(e,s,c);this.cycle(t,u,p,f,l)}}}cycle(e,t,s,n,r){this.affectedStickers[t]=!0,this.affectedStickers[s]=!0,this.affectedStickers[n]=!0,this.affectedStickers[r]=!0,e?this.cycleHelper(t,s,n,r):this.cycleHelper(r,n,s,t)}cycleHelper(e,t,s,n){let r=this.stickers[n];this.stickers[n]=this.stickers[s],this.stickers[s]=this.stickers[t],this.stickers[t]=this.stickers[e],this.stickers[e]=r}matchKeyToTurn(e){if(!this.disableTurn&&!e.ctrlKey)return this.matchKeyCodeToTurn(e.code)}matchKeyCodeToTurn(e){switch(e){case"KeyN":return this.cubeRotate(0,!0),{notation:"x",rotate:!0};case"KeyB":return this.cubeRotate(0,!1),{notation:"x'",rotate:!0};case"Semicolon":return this.cubeRotate(1,!0),{notation:"y",rotate:!0};case"KeyA":return this.cubeRotate(1,!1),{notation:"y'",rotate:!0};case"KeyP":return this.cubeRotate(2,!0),{notation:"z",rotate:!0};case"KeyQ":return this.cubeRotate(2,!1),{notation:"z'",rotate:!0};case"KeyJ":return this.turn(1,0,!0),{notation:"U",turn:!0};case"KeyF":return this.turn(1,0,!1),{notation:"U'",turn:!0};case"KeyS":return this.turn(1,this.layers-1,!1),{notation:"D",turn:!0};case"KeyL":return this.turn(1,this.layers-1,!0),{notation:"D'",turn:!0};case"KeyH":return this.turn(2,0,!0),{notation:"F",turn:!0};case"KeyG":return this.turn(2,0,!1),{notation:"F'",turn:!0};case"KeyW":return this.turn(2,this.layers-1,!1),{notation:"B",turn:!0};case"KeyO":return this.turn(2,this.layers-1,!0),{notation:"B'",turn:!0};case"KeyD":return this.turn(0,this.layers-1,!1),{notation:"L",turn:!0};case"KeyE":return this.turn(0,this.layers-1,!0),{notation:"L'",turn:!0};case"KeyI":return this.turn(0,0,!0),{notation:"R",turn:!0};case"KeyK":return this.turn(0,0,!1),{notation:"R'",turn:!0};case"BracketLeft":return this.sliceTurn(0,!1),{notation:"M",turn:!0};case"Quote":return this.sliceTurn(0,!0),{notation:"M'",turn:!0};case"KeyC":return this.sliceTurn(1,!1),{notation:"E",turn:!0};case"Comma":return this.sliceTurn(1,!0),{notation:"E'",turn:!0};case"KeyY":return this.sliceTurn(2,!0),{notation:"S",turn:!0};case"KeyT":return this.sliceTurn(2,!1),{notation:"S'",turn:!0};case"KeyU":return this.wideTurn(0,0,!0),{notation:"r",turn:!0};case"KeyM":return this.wideTurn(0,0,!1),{notation:"r'",turn:!0};case"KeyV":return this.wideTurn(0,this.layers-1,!1),{notation:"l",turn:!0};case"KeyR":return this.wideTurn(0,this.layers-1,!0),{notation:"l'",turn:!0}}}performMove(e,t){if(!e){console.log("Empty move. Skipping.");return}switch(e){case"x":this.cubeRotate(0,t);break;case"x'":this.cubeRotate(0,!t);break;case"x2":case"x2'":this.cubeRotate(0,t),this.cubeRotate(0,t);break;case"y":this.cubeRotate(1,t);break;case"y'":this.cubeRotate(1,!t);break;case"y2":case"y2'":this.cubeRotate(1,t),this.cubeRotate(1,t);break;case"z":this.cubeRotate(2,t);break;case"z'":this.cubeRotate(2,!t);break;case"z2":case"z2'":this.cubeRotate(2,t),this.cubeRotate(2,t);break;case"U":this.turn(1,0,t);break;case"U'":this.turn(1,0,!t);break;case"U2":case"U2'":this.turn(1,0,t),this.turn(1,0,t);break;case"u":this.wideTurn(1,0,t);break;case"u'":this.wideTurn(1,0,!t);break;case"u2":case"u2'":this.wideTurn(1,0,t),this.wideTurn(1,0,t);break;case"D":this.turn(1,this.layers-1,!t);break;case"D'":this.turn(1,this.layers-1,t);break;case"D2":case"D2'":this.turn(1,this.layers-1,t),this.turn(1,this.layers-1,t);break;case"d":this.wideTurn(1,this.layers-1,!t);break;case"d'":this.wideTurn(1,this.layers-1,t);break;case"d2":case"d2'":this.wideTurn(1,this.layers-1,t),this.wideTurn(1,this.layers-1,t);break;case"F":this.turn(2,0,t);break;case"F'":this.turn(2,0,!t);break;case"F2":case"F2'":this.turn(2,0,t),this.turn(2,0,t);break;case"f":this.wideTurn(2,0,t);break;case"f'":this.wideTurn(2,0,!t);break;case"f2":case"f2'":this.wideTurn(2,0,t),this.wideTurn(2,0,t);break;case"B":this.turn(2,this.layers-1,!t);break;case"B'":this.turn(2,this.layers-1,t);break;case"B2":case"B2'":this.turn(2,this.layers-1,t),this.turn(2,this.layers-1,t);break;case"b":this.wideTurn(2,this.layers-1,!t);break;case"b'":this.wideTurn(2,this.layers-1,t);break;case"b2":case"b2'":this.wideTurn(2,this.layers-1,t),this.wideTurn(2,this.layers-1,t);break;case"L":this.turn(0,this.layers-1,!t);break;case"L'":this.turn(0,this.layers-1,t);break;case"L2":case"L2'":this.turn(0,this.layers-1,t),this.turn(0,this.layers-1,t);break;case"l":this.wideTurn(0,this.layers-1,!t);break;case"l'":this.wideTurn(0,this.layers-1,t);break;case"l2":case"l2'":this.wideTurn(0,this.layers-1,t),this.wideTurn(0,this.layers-1,t);break;case"R":this.turn(0,0,t);break;case"R'":this.turn(0,0,!t);break;case"R2":case"R2'":this.turn(0,0,t),this.turn(0,0,t);break;case"r":this.wideTurn(0,0,t);break;case"r'":this.wideTurn(0,0,!t);break;case"r2":case"r2'":this.wideTurn(0,0,t),this.wideTurn(0,0,t);break;case"M":this.turn(0,1,!t);break;case"M'":this.turn(0,1,t);break;case"M2":case"M2'":this.sliceTurn(0,t),this.sliceTurn(0,t);break;case"E":this.sliceTurn(1,!t);break;case"E'":this.sliceTurn(1,t);break;case"E2":case"E2'":this.sliceTurn(1,t),this.sliceTurn(1,t);break;case"S":this.sliceTurn(2,t);break;case"S'":this.sliceTurn(2,!t);break;case"S2":case"S2'":this.sliceTurn(2,t);default:throw new Error("Invalid turn in algorithm: "+e)}}performAlg(e){if(!e){console.log("Empty alg. Skipping.");return}let t=e.split(" ");for(let s=0;s<t.length;s++)this.performMove(t[s],!0);this.animationQueue=[]}performAlgReverse(e){if(!e){console.log("Empty alg. Skipping.");return}let t=e.split(" ");for(let s=t.length-1;s>=0;s--)this.performMove(t[s],!1);this.animationQueue=[]}stickerIsOnFace(e,t){return t*d(this.layers)<=e&&e<(t+1)*d(this.layers)}stickerToFace(e){return Math.floor(e/d(this.layers))}center(e){return e*d(this.layers)+Math.floor(d(this.layers)/2)}corners(e,t){const s=e*d(this.layers);return{topLeft:s+(this.layers+1)*t,topRight:s+(this.layers-1)*(this.layers-t),bottomRight:s+(this.layers+1)*(this.layers-t-1),bottomLeft:s+(this.layers-1)*(t+1)}}edges(e,t,s){const n=this.corners(e,t);let r=this.layers-2*(t+1);return{top:n.topLeft+this.layers*(s+1),left:n.topLeft+(r-s),right:n.topRight+s+1,bottom:n.bottomLeft+this.layers*(r-s)}}}function mt(i,e){return i/e*2-1}function pt(i,e){return 1-i/e*2}function st(i,e,t,s){return i<t?(s-e)/(t-i):(e-s)/(i-t)}function G(i,e,t,s,n,r){return Math.abs(.5*(i*(s-r)+t*(r-e)+n*(e-s)))}function Qt(i,e){return i.layers-1-e%i.layers}function nt(i,e){return i.layers-1-Math.floor(e/i.layers)}function Wt(i,e){return e%i.layers}function rt(i,e){return i.layers-1-Math.floor((e-d(i.layers))/i.layers)}class Gt{numOfPointerMoves;xOnDown;yOnDown;xOnMove;yOnMove;stickerOnDown;cart2dOnDown;onPointerDown(e,t,s,n){const r=n.buffers;this.numOfPointerMoves=0;const a=mt(e,s.clientWidth),o=pt(t,s.clientHeight);this.xOnDown=a,this.yOnDown=o,[this.stickerOnDown,this.cart2dOnDown]=this._coordinatesToSticker(a,o,n,r);function h(k,x,g){return{x:r[k].cart2d[x],y:r[k].cart2d[g]}}if(this.stickerOnDown!==-1)return;const c=h(0,0,1),u=h(n.layers*(n.layers-1),6,7),l=h(n.layers-1,2,3),f=h(d(n.layers)-1,4,5),p=h(n.layers*(n.layers+1)-1,0,1),m=h(d(n.layers)*2-1,2,3);o>c.y&&a>c.x&&a<u.x?n.cubeRotate(0,!0):a<c.x&&o>l.y&&o<c.y?n.cubeRotate(2,!1):a>u.x&&o>f.y&&o<u.y?n.cubeRotate(2,!0):a<p.x&&o>p.y&&o<l.y?n.cubeRotate(1,!0):a>m.x&&o>m.y&&o<f.y?n.cubeRotate(1,!1):o<p.y&&a>p.x&&a<m.x&&n.cubeRotate(0,!1)}onPointerMove(e,t){this.numOfPointerMoves++,this.xOnMove=e,this.yOnMove=t}onPointerUp(e,t){if(this.numOfPointerMoves<2)return;let s,n;if(this.stickerOnDown!==-1&&(s=st(this.cart2dOnDown[0],this.cart2dOnDown[1],this.cart2dOnDown[4],this.cart2dOnDown[5]),n=st(this.cart2dOnDown[2],this.cart2dOnDown[3],this.cart2dOnDown[6],this.cart2dOnDown[7]),s<0)){const h=s;s=n,n=h}const r=mt(this.xOnMove,e.clientWidth),a=pt(this.yOnMove,e.clientHeight),o=st(r,a,this.xOnDown,this.yOnDown);t.stickerIsOnFace(this.stickerOnDown,0)?r===this.xOnDown?t.turn(0,nt(t,this.stickerOnDown),a>this.yOnDown):o>s?t.turn(0,nt(t,this.stickerOnDown),r>this.xOnDown):o<n?t.turn(0,nt(t,this.stickerOnDown),r<this.xOnDown):t.turn(2,Qt(t,this.stickerOnDown),r>this.xOnDown):t.stickerIsOnFace(this.stickerOnDown,1)&&(r===this.xOnDown?t.turn(0,rt(t,this.stickerOnDown),a>this.yOnDown):o>s?t.turn(0,rt(t,this.stickerOnDown),r>this.xOnDown):o<n?t.turn(0,rt(t,this.stickerOnDown),r<this.xOnDown):t.turn(1,Wt(t,this.stickerOnDown),r<this.xOnDown))}_coordinatesToSticker(e,t,s,n){const r=a=>{if(!n[a].cart2d){console.error("cart2d is undefined");return}const o=n[a].cart2d,h=G(o[0],o[1],o[2],o[3],o[4],o[5])+G(o[0],o[1],o[4],o[5],o[6],o[7]),c=G(e,t,o[0],o[1],o[2],o[3])+G(e,t,o[2],o[3],o[4],o[5])+G(e,t,o[4],o[5],o[6],o[7])+G(e,t,o[6],o[7],o[0],o[1]),u=1e-5;if(Math.abs(h-c)<u)return[a,o]};for(let a=0;a<2*d(s.layers);a++){const o=r(a);if(o)return o}return[-1,void 0]}}function q(){return[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]}function Vt(i,e,t,s,n){const r=1/Math.tan(e/2);if(i[0]=r/t,i[1]=0,i[2]=0,i[3]=0,i[4]=0,i[5]=r,i[6]=0,i[7]=0,i[8]=0,i[9]=0,i[11]=-1,i[12]=0,i[13]=0,i[15]=0,n!=null&&n!==1/0){const a=1/(s-n);i[10]=(n+s)*a,i[14]=2*n*s*a}else i[10]=-1,i[14]=-2*s;return i}function Z(i,e,t,s){let n=s[0],r=s[1],a=s[2],o=1/Math.hypot(n,r,a);n*=o,r*=o,a*=o;let h=Math.sin(t),c=Math.cos(t),u=1-c,l=e[0],f=e[1],p=e[2],m=e[3],k=e[4],x=e[5],g=e[6],N=e[7],S=e[8],A=e[9],O=e[10],Q=e[11],M=n*n*u+c,D=r*n*u+a*h,F=a*n*u-r*h,L=n*r*u-a*h,B=r*r*u+c,C=a*r*u+n*h,T=n*a*u+r*h,E=r*a*u-n*h,_=a*a*u+c;return i[0]=l*M+k*D+S*F,i[1]=f*M+x*D+A*F,i[2]=p*M+g*D+O*F,i[3]=m*M+N*D+Q*F,i[4]=l*L+k*B+S*C,i[5]=f*L+x*B+A*C,i[6]=p*L+g*B+O*C,i[7]=m*L+N*B+Q*C,i[8]=l*T+k*E+S*_,i[9]=f*T+x*E+A*_,i[10]=p*T+g*E+O*_,i[11]=m*T+N*E+Q*_,e!==i&&(i[12]=e[12],i[13]=e[13],i[14]=e[14],i[15]=e[15]),i}function Xt(i,e){let t=e[0],s=e[1],n=e[2];return i[12]+=i[0]*t+i[4]*s+i[7]*n,i[13]+=i[1]*t+i[5]*s+i[8]*n,i[14]+=i[2]*t+i[5]*s+i[9]*n,i[15]+=i[3]*t+i[6]*s+i[10]*n,i}function bt(){let i;return e=>(i||(i=e()),i)}const $t=100,qt=15;class Zt{position;_velocity;_acceleration;target;constructor(){this.position=0,this._velocity=200,this._acceleration=0,this.target=0}update(e){const t=-$t*(this.position-this.target),s=-qt*this._velocity;this._acceleration=t+s,this._velocity+=this._acceleration*e,this.position+=this._velocity*e}}let P=Jt(),b=te(P),K=ee(b);function Jt(){const i=document.createElement("canvas");return i.style.position="fixed",i.style.display="block",i.style.top="0",i.style.left="0",i.style.width="100vw",i.style.height="100vh",i.style.zIndex="-1",document.body.appendChild(i),document.addEventListener("keydown",e=>{ht.forEach(t=>{t.enableKey(e)&&t.cube.matchKeyToTurn(e)})}),i}function te(i){return i.getContext("webgl")}function ee(i){const s=re(i,`
    attribute vec4 aVertexPosition;
    attribute vec4 aVertexColor;
    uniform mat4 uTransformMatrix;
    uniform mat4 uRotateMatrix;

    // variables shared between vertex and fragment shaders
    varying lowp vec4 vColor;
    varying lowp vec4 originalPos;
    varying lowp vec4 rotatedPos;
    void main(void) {
        gl_Position = uTransformMatrix * aVertexPosition;
        originalPos = aVertexPosition;
        rotatedPos = uRotateMatrix * aVertexPosition;
        vColor = aVertexColor;
    }
    `,`
    // variables shared between vertex and fragment shaders
    varying lowp vec4 vColor;
    varying lowp vec4 originalPos;
    varying lowp vec4 rotatedPos;

    void main(void) {
        gl_FragColor = vColor;

        // low precision float variable
        lowp float max = 1.05;

        // if it is a normal sticker rather than a hint sticker, it should not be discarded
        if (originalPos.x < max && originalPos.x > -max && originalPos.y < max && originalPos.y > -max && originalPos.z < max && originalPos.z > -max) {
            return;
        }

        // if it starts on the right or left, and stays on its side, it should not be discarded
        if (originalPos.x > max && rotatedPos.x > max) return;
        if (originalPos.x < -max && rotatedPos.x < -max) return;

        if (rotatedPos.y < max && rotatedPos.z < max) return;
        discard;
    }
    `);return i.useProgram(s),{attribLocations:{vertexPosition:i.getAttribLocation(s,"aVertexPosition"),vertexColor:i.getAttribLocation(s,"aVertexColor")},uniformLocations:{transformMatrix:i.getUniformLocation(s,"uTransformMatrix"),rotateMatrix:i.getUniformLocation(s,"uRotateMatrix")}}}let ht=[],Tt=[],yt=Date.now()*.001,kt=!1;function ie(){kt||(kt=!0,requestAnimationFrame(Rt))}function he(i,e=3){let t=se(i),s=new Nt(b,t);s.setNumOfLayers(e);let n=new Zt,r=new Gt,a={cube:s,dragEnabled:!0,enableKey:h=>!0},o={cube:s,div:i,spring:n};return ne(i,r,a),ht.push(a),Tt.push(o),ie(),a}function se(i){let e=q();return Vt(e,50*Math.PI/180,i.clientWidth/i.clientHeight,.1,100),Xt(e,[0,0,-5]),Z(e,e,45*Math.PI/180,[1,0,0]),Z(e,e,0,[0,-1,0]),e}function ne(i,e,t){const s=(c,u)=>{t.dragEnabled&&e.onPointerDown(c,u,i,t.cube)},n=(c,u)=>{t.dragEnabled&&e.onPointerMove(c,u)},r=()=>{t.dragEnabled&&e.onPointerUp(i,t.cube)},a=c=>{const u=c.target.getBoundingClientRect(),l=c.touches[0].pageX-u.left,f=c.touches[0].pageY-u.top;return{x:l,y:f}},o=()=>{i.addEventListener("pointerdown",c=>s(c.offsetX,c.offsetY)),i.addEventListener("pointermove",c=>n(c.offsetX,c.offsetY)),i.addEventListener("pointerup",()=>r())},h=()=>{i.addEventListener("touchstart",c=>{const{x:u,y:l}=a(c);s(u,l)}),i.addEventListener("touchmove",c=>{const{x:u,y:l}=a(c);n(u,l)}),i.addEventListener("touchend",()=>{r()})};window.PointerEvent?o():h(),i.style.touchAction="none"}function ot(i,e,t){t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribPointer(e.attribLocations.vertexPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(e.attribLocations.vertexPosition)}function at(i,e,t){t.bindBuffer(t.ARRAY_BUFFER,i),t.vertexAttribPointer(e.attribLocations.vertexColor,4,t.FLOAT,!1,0,0),t.enableVertexAttribArray(e.attribLocations.vertexColor)}function ct(i){i.drawElements(i.TRIANGLES,6,i.UNSIGNED_SHORT,0)}function re(i,e,t){const s=xt(i,i.VERTEX_SHADER,e),n=xt(i,i.FRAGMENT_SHADER,t),r=i.createProgram();return i.attachShader(r,s),i.attachShader(r,n),i.linkProgram(r),i.getProgramParameter(r,i.LINK_STATUS)?r:(alert("Unable to initialize the shader program: "+i.getProgramInfoLog(r)),null)}function xt(i,e,t){const s=i.createShader(e);return i.shaderSource(s,t),i.compileShader(s),i.getShaderParameter(s,i.COMPILE_STATUS)?s:(alert("An error occurred compiling the shaders: "+i.getShaderInfoLog(s)),i.deleteShader(s),null)}function oe(){const i=P.clientWidth,e=P.clientHeight,t=P.width!==i||P.height!==e;return t&&(P.width=i,P.height=e),t}function Rt(i){i*=.001;const e=i-yt;yt=i,oe(),b.enable(b.DEPTH_TEST),b.enable(b.SCISSOR_TEST),b.depthFunc(b.LEQUAL),b.clear(b.COLOR_BUFFER_BIT|b.DEPTH_BUFFER_BIT);for(let t=0;t<ht.length;t++){const{cube:s,div:n,spring:r}=Tt[t],a=n.getBoundingClientRect();if(a.bottom<0||a.top>P.clientHeight||a.right<0||a.left>P.clientWidth)continue;const o=a.right-a.left,h=a.bottom-a.top,c=a.left,u=P.clientHeight-a.bottom;b.viewport(c,u,o,h),b.scissor(c,u,o,h),s.animationQueue[0]&&(r.target=s.animationQueue.length*90,r.update(e),r.position>=90&&(s.affectedStickers=Array(R(s.layers)).fill(!1),r.position=0,s.animationQueue.shift()));const l=s.animationQueue[0];let f=ae(s),p=bt(),m=bt();for(let k=0;k<R(s.layers);k++){let x=s.buffers[k];const g=l&&l.stickersToAnimate[k]?p(()=>Z(q(),s.perspectiveMatrix,r.position*Math.PI/180,l.axis)):s.perspectiveMatrix;b.uniformMatrix4fv(K.uniformLocations.transformMatrix,!1,g);const N=l&&l.stickersToAnimate[k]?m(()=>{const S=q();return Z(S,S,r.position*Math.PI/180,l.axis)}):q();b.uniformMatrix4fv(K.uniformLocations.rotateMatrix,!1,N),b.bindBuffer(b.ELEMENT_ARRAY_BUFFER,x.indexBuffer),ot(x.positionBuffer,K,b),at(f[k].buffer,K,b),ct(b),ot(x.noGapPositionBuffer,K,b),at(s.underStickers[k].buffer,K,b),ct(b),ot(x.hintPositionBuffer,K,b),at(f[k].buffer,K,b),ct(b)}}requestAnimationFrame(Rt)}function ae(i){return i.animationQueue[0]?i.animationQueue[0].stickers:i.stickers}export{ce as G,he as n,it as s};
